---
title: "Feature engineering"
output:
  pdf_document: default
  html_notebook: default
---

# **Load Libraries**

```{r message=FALSE, warning=FALSE}
library(tidyverse) # common libraries
```

### **Load Data**

```{r}
df<-read.csv("rent-amount.csv")
```

```{r}
head(df)
```

In EDA we conclude that the data set has too many outliers, which is why they require a type of processing.

I can think of 3 ways to deal with the situation.

* Remove outliers.
* Replace abnormal values by statistical measures.
* Perform a logarithmic transformation
* Calculate an upper range and based on the range replace outliers with normal values.

The first and second options are ruled out, since the data set has very few observations. And if we replace the outliers with statistical measures such as the mean or the median, we would be dirtying the data set, we would be affecting the distribution of the data.

We can combine the 3 and 4 option, we can establish an **upper range**. Based on the interval we create a criterion, we make a **sample** of random values that oscillate in those ranges. To be able to **replace** them and then perform a **logarithmic transformation** to smooth the data, improving their distribution.

```{r message=FALSE, warning=FALSE}
attach(df)
```

```{r}
upper_limit<-function(x,limit){
  mean<-mean(x) # calculate mean
  sd<-sd(x) # calculate standard division
  
  mean+limit*sd # calculate upper range 
}
```





```{r}

calculate_upper_limit<-function(feature){
  
  limits<-c(2,2.5,3,3.5,4)
  for(index in 1:5){
    
    print(paste("Upper Limit",limits[index]))
    print(upper_limit(feature,limits[index]))
    print("====================")
}
}

```



#### **Upper Limits**

##### **Rent Amount**

```{r}
calculate_upper_limit(feature = rent.amount)
```
The best upper limit is 3 which we can round up to $15,000 dollars. Since there are more rental houses that are around those prices as we can see in the histogram.

#### **Fire Insurence**


```{r}
calculate_upper_limit(feature = fire.insurance)
```
With an upper limit of 4 it is good. 
With an upper limit of 4 it is good. We can round it up to $250 dollars since there are very few cases where the price of fire insurance exceeds that amount.

#### **Area**


```{r}
calculate_upper_limit(feature = area)
```
With an upper limit of 2.5 it is a good point. Since most of the departments do not exceed 1000 square meters.

```{r}
replace_outlires<-function(data,normal_sample,upper_limit){
  
  return(ifelse(data>upper_limit,normal_sample,data))
}
```

### **Normal Values Sample for Upper Limit**

```{r}
set.seed(2018) # we define random seed, so that the numbers generated by the sample do not vary.
sample_rent<-sample(14500:15000,size=25,replace = T)
sample_fire_insurence<-sample(240:250,size=10,replace = T)
sample_area<-sample(900:1000,size=25,replace = T)
```

```{r}
normal_values_rent<-replace_outlires(data=df$rent.amount,sample_rent,upper_limit = 15000)
normal_fire_insurence<-replace_outlires(data=df$fire.insurance,sample_fire_insurence,upper_limit = 250)
normal_area<-replace_outlires(data=area,sample_area,upper_limit = 1000)
```

## **Replace Outlires Values**

```{r}
df<- df %>%
  mutate(rent.amount=normal_values_rent) %>%
  mutate(fire.insurance=normal_fire_insurence) %>%
  mutate(area=normal_area)
```


With the mutate function we make modifications. We replace outliers with normal values, using a random sample.

##### **We check the changes**

```{r}
df %>% select(rent.amount,area,fire.insurance) %>% summary()
```

```{r}
df<- df %>% mutate(fire.insurance=ifelse(fire.insurance==3,5,fire.insurance))
```

We replaced the minimum price value of fire insurance by five dollars.

```{r}
df %>% select(fire.insurance) %>% summary()
```

#### **logarithmic transformation**

```{r}
df<- df %>%
  
  mutate(area_log=log(area)) %>%
  mutate(fire.insurance_log=log(fire.insurance)) %>%
  mutate(rent.amount_log=log(rent.amount))

```

We perform logarithmic transformation to improve the distribution of continuous data.


```{r}
histogram<-function(x,...){
    
    df %>%
      ggplot(aes(x=x,y=..density..)) +
      geom_histogram(color="black",fill="#FFF0C9") +
      geom_density(color="black",lwd=1) +
      geom_vline(aes(xintercept=mean(x),color="mean")) +
      geom_vline(aes(xintercept=median(x),color="median")) +
      labs(col="Stadistcs") +
      theme(legend.position = "top") +
      ...
    
  }
```

```{r message=FALSE, warning=FALSE}
library(gridExtra)
```

```{r}
rent_amount_histogram=histogram(df$rent.amount,labs(x="Rent Amount",title = "Rent Amount"))
area_hsitogram=histogram(df$area,labs(x="Area",title = "Area"))
fire_insurence_histogram=histogram(df$fire.insurance,labs(x="Fire Insurence",title = "Fire Insurence"))

rent_amount_histogram_log=histogram(df$rent.amount_log,labs(x="Rent Amount",title = "Rent Amount Log"))
area_histogram_log=histogram(df$area_log,labs(x="Area",title = "Area Log "))
fire_insurence_histogram_log=histogram(df$fire.insurance_log,labs(x="Fire Insurence",title = "Fire Insurence Log"))

```


```{r}
grid.arrange(rent_amount_histogram,
             rent_amount_histogram_log,nrow=1)
         
```

```{r}
grid.arrange(fire_insurence_histogram,
             fire_insurence_histogram_log,nrow=1)
```
```{r}
grid.arrange(area_hsitogram,
             area_histogram_log,nrow=1)
```
We observed a great improvement in the distribution of the data.

```{r}
scattter_plot<-function(x_feature,...){
 
  ggplot(data=df,aes(x=x_feature,y=rent.amount)) +
  geom_point(color="#77dd77",alpha=0.5) +
  theme_light() +
  geom_smooth(method = "lm",color="red") +
  ...
}
```


```{r}
rooms_scatter<-scattter_plot(df$rooms,labs(x="Rooms",y="Rent Amount"))
bathroom_scatter<-scattter_plot(df$bathroom,labs(x="Bathroom",y="Rent Amount"))
floor_scatter<-scattter_plot(df$floor,labs(x="Floor",y="Rent Amount"))
parking_spaces_scatter<-scattter_plot(df$parking.spaces,labs(x="Parking Spaces",y="Rent Amount"))
```


```{r}
grid.arrange(rooms_scatter,
             bathroom_scatter,
             floor_scatter,
             parking_spaces_scatter)
             
```
We can replace values greater than 7, since there are few departments that exceed that number of rooms. I will replace it with a value of 7, since there is little data and it will not affect the distribution of the data.


For the bathrooms we can change replace those values that are greater than 8, since there are very few bathrooms greater than the mentioned amount.

There are very few departments where the buildings of the rental houses are greater than 30.


There are very few apartments, where parking spaces exceed 8 units.

```{r}
replace_values<-function(x,limit){
  
  ifelse(x>limit,limit,x)
  
}
```


```{r}
replace_rooms<-mapply(replace_values,rooms,7)
replace_bathrooms<-mapply(replace_values,bathroom,8)
replace_floor<-mapply(replace_values,floor,30)
replace_spaces_parking<-mapply(replace_values,parking.spaces,8)
```

```{r}
df<- df %>%
  mutate(replace_rooms=replace_rooms) %>%
  mutate(replace_bathrooms=replace_bathrooms) %>%
  mutate(replace_floor=replace_floor)%>%
  mutate(replace_parking=replace_spaces_parking)
  
```

```{r}
rooms_scatter_replace<-scattter_plot(df$replace_rooms,labs(x="Rooms",y="Rent Amount",title ="Replace Values"))
bathroom_scatter_replace<-scattter_plot(df$replace_bathrooms,labs(x="Bathroom",y="Rent Amount",title = "Replace Values"))
floor_scatter_replace<-scattter_plot(df$replace_floor,labs(x="Floor",y="Rent Amount",title = "Replace Values"))
parking_scatter_replace<-scattter_plot(df$replace_parking,labs(x="Floor",y="Rent Amount",title = "Replace Values"))

```

```{r}
grid.arrange(rooms_scatter,rooms_scatter_replace,nrow=1)
```
```{r}
grid.arrange(bathroom_scatter,bathroom_scatter_replace,nrow=1)
```

```{r}
grid.arrange(floor_scatter,floor_scatter_replace,nrow=1)
```
```{r}
grid.arrange(parking_spaces_scatter,parking_scatter_replace,nrow=1)
```



We finish with the cleaning of our data.

#### **We remove old variables**

```{r}
df<-df %>% 
  
  select(-rent.amount,-area,-fire.insurance) %>% 
  select(-rooms,-bathroom,-floor,-parking.spaces)
```


#### **Rename Features**


```{r}
df_clear<-df %>%
  rename(fire.insurance=fire.insurance_log,
         area=area_log,
         rent.amount=rent.amount_log) %>%
  
  rename(bathrooms=replace_bathrooms,
         floor=replace_floor,
         rooms=replace_rooms) 
  
  
```


```{r}
df_clear<- df_clear %>%
  rename(parking.spaces=replace_parking)
```
```{r}
library(DataExplorer) # correlation matrix
```

```{r}
plot_correlation(df_clear,title = "Correlation Matrix")
```


## **Save Dataframe clear**

```{r}
write.csv(df_clear,"rent-amount-clear.csv",row.names = FALSE)
```

